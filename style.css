let SAVE_KEY_GAME = "cc_game_v2";

let coin = 0;
let klik_kracht = 1;
let currentThemeIndex = -1;

let upgradeCounts = Array(8).fill(0);
let autoCoinIncrements = Array(8).fill(0);

let COSTS = [10, 50, 100, 1000, 2000, 10000, 50000, 100000];
let CLICK_INC = [1, 2, 3, 5, 10, 20, 50, 100];
let AUTO_INC = [1, 5, 10, 100, 200, 1000, 5000, 10000];

let THEMES = [
    {
        name: "Bank",
        file: "bank.png"
    },
    {
        name: "Exchange",
        file: "exchange.png"
    },
    {
        name: "Global Trade",
        file: "global_trade.png"
    },
    {
        name: "Stock Market",
        file: "Stock Market.png"
    },
    {
        name: "Tax",
        file: "tax.png"
    },
    {
        name: "Wallet",
        file: "wallet.png"
    },
    {
        name: "Bitcoin",
        file: "bitcoin.png"
    },
    {
        name: "investment",
        file: "investment.png"
    },
];

let WORLDS = {
    default: {
        title: "Normal",
        coin: "Coin.png",
        bg: "Marioworld.png",
        themeIndex: -1
    },
    cake: {
        title: "Cake World",
        coin: "Minecraft.png",
        bg: "Grass.png",
        themeIndex: 0
    },
    diamond: {
        title: "Diamond World",
        coin: "Diamond.png",
        bg: "Mine.png",
        themeIndex: 1
    },
    galaxy: {
        title: "Galaxy World",
        coin: "Galaxy.png",
        bg: "Space.png",
        themeIndex: 2
    },
    crown: {
        title: "Royal World",
        coin: "Crown.png",
        bg: "Palace.png",
        themeIndex: 3
    },
    soccer: {
        title: "Soccer World",
        coin: "Soccer.png",
        bg: "Stadion.png",
        themeIndex: 4
    },
    arcade: {
        title: "Arcade World",
        coin: "Arcade.png",
        bg: "Gamestate.png",
        themeIndex: 5
    },
    death: {
        title: "Death World",
        coin: "Death.png",
        bg: "Graveyard.png",
        themeIndex: 6
    },
    angel: {
        title: "Heaven World",
        coin: "Engel.png",
        bg: "Heaven.png",
        themeIndex: 7
    },
};

function getUnlockedSet() {
    try {
        let raw = localStorage.getItem("unlocked_set");
        return raw ? new Set(JSON.parse(raw)) : new Set();
    } catch {
        return new Set();
    }
}

function getUnlockedOrder() {
    try {
        let raw = localStorage.getItem("unlocked_order");
        return raw ? JSON.parse(raw) : [];
    } catch {
        return [];
    }
}

function saveUnlocked(set, order) {
    localStorage.setItem("unlocked_set", JSON.stringify(Array.from(set)));
    localStorage.setItem("unlocked_order", JSON.stringify(order));
}

function getCurrentWorldKey() {
    return localStorage.getItem("current_world_key") || "";
}

function setCurrentWorldKey(key) {
    localStorage.setItem("current_world_key", key);
}

function addUnlock(key) {
    if (!WORLDS[key]) return;
    let set = getUnlockedSet();
    let order = getUnlockedOrder();
    if (!set.has(key)) {
        set.add(key);
        if (key === "default") {
            order.unshift("default");
        } else {
            if (!order.includes("default")) order.unshift("default");
            order.push(key);
        }
        saveUnlocked(set, order);
        renderUnlocked();
    }
}

function reconcileUnlocksWithProgress() {
    let allowed = new Set(["default"]);
    if (upgradeCounts[0] >= 50) allowed.add("cake");
    if (upgradeCounts[1] >= 100) allowed.add("diamond");
    if (upgradeCounts[2] >= 150) allowed.add("galaxy");
    if (upgradeCounts[3] >= 200) allowed.add("crown");
    if (upgradeCounts[4] >= 250) allowed.add("soccer");
    if (upgradeCounts[5] >= 300) allowed.add("arcade");
    if (upgradeCounts[6] >= 350) allowed.add("death");
    if (upgradeCounts[7] >= 400) allowed.add("angel");

    let oldOrder = getUnlockedOrder();
    let newOrder = ["default"];
    for (let key of oldOrder) {
        if (allowed.has(key) && !newOrder.includes(key) && key !== "default") newOrder.push(key);
    }
    let canonical = ["cake", "diamond", "galaxy", "crown", "soccer", "arcade", "death", "angel"];
    for (let key of canonical) {
        if (allowed.has(key) && !newOrder.includes(key)) newOrder.push(key);
    }
    saveUnlocked(allowed, newOrder);

    let cur = getCurrentWorldKey();
    if (!allowed.has(cur)) {
        setCurrentWorldKey("default");
    }
}

function ensureUnlockedPanel() {
    if (!document.getElementById("unlocked_panel")) {
        let panel = document.createElement("div");
        panel.id = "unlocked_panel";
        panel.className = "unlocked-panel";
        panel.innerHTML = `
      <h3>Unlocked Worlds</h3>
      <div id="unlocked_list" class="unlocked-list"></div>
      <div class="panel-controls" style="margin-top:10px;display:flex;justify-content:flex-end;">
        <button id="btnReset" type="button">Reset progress</button>
        <button id="btn-minigame">Start Minigame</button>
        <div id="minigame-overlay" class="minigame-overlay" style="display:none;">
          <div class="minigame-container">
            <h2>Minigame: Klik zoveel mogelijk munten!</h2>
            <div id="minigame-timer">60</div>
            <div id="minigame-score">Score: 0</div>
            <img src="Coin.png" id="minigame-coin" class="coin-icon" alt="Coin">
            <div id="minigame-result" style="display:none;">
              <p id="minigame-final-score"></p>
              <p id="minigame-highscore"></p>
              <button id="btn-return">Terug naar hoofdspel</button>
            </div>
          </div>
        </div>
      </div>
    `;
        document.querySelector(".buttons").appendChild(panel);
        panel.querySelector("#btnReset").addEventListener("click", () => {
            if (confirm("Weet je zeker dat je ALLES wilt resetten?")) {
                hardReset();
            }
        });
    }
}

function renderUnlocked() {
    ensureUnlockedPanel();
    let list = document.getElementById("unlocked_list");
    list.innerHTML = "";
    let order = getUnlockedOrder();
    let currentKey = getCurrentWorldKey();
    if (!order.includes("default")) order = ["default", ...order];
    order.forEach(key => {
        let meta = WORLDS[key];
        if (!meta) return;
        let btn = document.createElement("button");
        btn.type = "button";
        btn.className = "unlock-badge" + (key === currentKey ? " active" : "");
        btn.innerHTML = `
      <img src="${meta.coin}" alt="${meta.title}">
      <div class="name">${meta.title}</div>
    `;
        btn.addEventListener("click", () => {
            applyWorldByKey(key, true);
        });
        list.appendChild(btn);
    });
}

function applyWorldByKey(key, fromUserClick = false) {
    let meta = WORLDS[key];
    if (!meta) return;
    let coinImg = document.querySelector(".coin-icon");
    coinImg.src = meta.coin;
    document.body.style.backgroundImage = `url("${meta.bg}")`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundRepeat = "no-repeat";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundAttachment = "fixed";
    currentThemeIndex = meta.themeIndex ?? -1;
    setCurrentWorldKey(key);
    highlightCurrentWorld();
    if (fromUserClick) {
        let rect = coinImg.getBoundingClientRect();
        let particleClass = getParticleClass(currentThemeIndex);
        spawnParticles(particleClass, rect.left + rect.width / 2, rect.top + rect.height / 2, 10);
    }
}

function highlightCurrentWorld() {
    let currentKey = getCurrentWorldKey();
    document.querySelectorAll(".unlock-badge").forEach(el => el.classList.remove("active"));
    let order = getUnlockedOrder();
    let idx = order.indexOf(currentKey);
    let list = document.getElementById("unlocked_list");
    let highlightIndex = idx;
    if (currentKey === "default") highlightIndex = 0;
    if (list && highlightIndex > -1 && list.children[highlightIndex]) {
        list.children[highlightIndex].classList.add("active");
    } else if (currentKey === "default" && list && list.children[0]) {
        list.children[0].classList.add("active");
    }
}

function click_actie() {
    coin += klik_kracht;
    ui_update();
    let coinImg = document.querySelector('.coin-icon');
    coinImg.classList.add('clicked');
    setTimeout(() => coinImg.classList.remove('clicked'), 100);
    createFloatingText(`+${klik_kracht}`);
    let rect = coinImg.getBoundingClientRect();
    spawnParticles(getParticleClass(currentThemeIndex), rect.left + rect.width / 2, rect.top + rect.height / 2, 5);
    playPlop();
}

function createFloatingText(text) {
    let coinImg = document.querySelector('.coin-icon');
    let rect = coinImg.getBoundingClientRect();
    let floating = document.createElement('div');
    floating.className = 'floating-text';
    floating.innerText = text;
    floating.style.left = rect.left + rect.width / 2 + 'px';
    floating.style.top = rect.top + rect.height / 2 + 'px';
    document.body.appendChild(floating);
    setTimeout(() => floating.remove(), 900);
}

function spawnParticles(particleClass, x, y, count) {
    for (let i = 0; i < count; i++) {
        let p = document.createElement("div");
        p.className = particleClass;
        let angle = Math.random() * 2 * Math.PI;
        let distance = 40 + Math.random() * 30;
        let offsetX = Math.cos(angle) * distance;
        let offsetY = Math.sin(angle) * distance;
        let rotation = Math.random() * 360;
        let scale = 0.5 + Math.random() * 0.5;
        p.style.setProperty("--x", `${offsetX}px`);
        p.style.setProperty("--y", `${offsetY}px`);
        p.style.left = x + "px";
        p.style.top = y + "px";
        p.style.transform = `rotate(${rotation}deg) scale(${scale})`;
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 800);
    }
}

function getParticleClass(themeIndex) {
    switch (themeIndex) {
        case 0:
            return "cake-particle";
        case 1:
            return "diamond-particle";
        case 2:
            return "galaxy-particle";
        case 3:
            return "crown-particle";
        case 4:
            return "soccer-particle";
        case 5:
            return "arcade-particle";
        case 6:
            return "death-particle";
        case 7:
            return "angel-particle";
        default:
            return "coin-particle";
    }
}

function Upgrade(index) {
    if (coin >= COSTS[index]) {
        coin -= COSTS[index];
        upgradeCounts[index]++;
        recalcFromCounts();
        document.getElementById(`count${index}`).innerText = upgradeCounts[index];
        ui_update();
        flashButton(`upgrade${COSTS[index]}`);
        showExtraUpgrade(index);
        playKaching();
        if (index === 0 && upgradeCounts[0] === 50) {
            unlockWorld(0, "Minecraft.png", "Grass.png", "ðŸŽ‰ Cake World unlocked! ðŸ°", "cake");
        }
        if (index === 1 && upgradeCounts[1] === 100) {
            unlockWorld(1, "Diamond.png", "Mine.png", "ðŸ’Ž Diamond World unlocked!", "diamond");
        }
        if (index === 2 && upgradeCounts[2] === 150) {
            unlockWorld(2, "Galaxy.png", "Space.png", "ðŸŒŒ Galaxy World unlocked!", "galaxy");
        }
        if (index === 3 && upgradeCounts[3] === 200) {
            unlockWorld(3, "Crown.png", "Palace.png", "ðŸ‘‘ Royal World unlocked!", "crown");
        }
        if (index === 4 && upgradeCounts[4] === 250) {
            unlockWorld(4, "Soccer.png", "Stadion.png", "âš½ Soccer World unlocked!", "soccer");
        }
        if (index === 5 && upgradeCounts[5] === 300) {
            unlockWorld(5, "Arcade.png", "Gamestate.png", "ðŸ•¹ï¸ Arcade World unlocked!", "arcade");
        }
        if (index === 6 && upgradeCounts[6] === 350) {
            unlockWorld(6, "Death.png", "Graveyard.png", "â˜ ï¸ Death World unlocked! The Final Stage!", "death");
        }
        if (index === 7 && upgradeCounts[7] === 400) {
            unlockWorld(7, "Engel.png", "Heaven.png", "ðŸ˜‡ Heaven World unlocked! Ascension achieved!", "angel");
        }
        saveGame();
    }
}

function showExtraUpgrade(index) {
    let extraContainer = document.getElementById("extra_upgrades");
    if (!extraContainer.querySelector(`#extra_${index}`)) {
        let img = document.createElement("img");
        img.src = (THEMES[index] && THEMES[index].file) ? THEMES[index].file : "Coin.png";
        img.id = `extra_${index}`;
        img.className = "extra-upgrade";
        extraContainer.appendChild(img);
    }
}

function unlockWorld(themeIndex, coinImage, bgImage, message, unlockKey) {
    let coinImg = document.querySelector(".coin-icon");
    coinImg.src = coinImage;
    document.body.style.backgroundImage = `url("${bgImage}")`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundRepeat = "no-repeat";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundAttachment = "fixed";
    currentThemeIndex = themeIndex;
    let rect = coinImg.getBoundingClientRect();
    let particleClass = getParticleClass(themeIndex);
    spawnParticles(particleClass, rect.left + rect.width / 2, rect.top + rect.height / 2, 15);
    let popup = document.getElementById("achievementPopup");
    popup.innerText = message;
    popup.style.display = "block";
    popup.style.animation = "popupFade 2s forwards";
    setTimeout(() => (popup.style.display = "none"), 2000);
    if (unlockKey) {
        addUnlock(unlockKey);
        setCurrentWorldKey(unlockKey);
        renderUnlocked();
        highlightCurrentWorld();
    }
}

function ui_update() {
    document.getElementById("coin_counter").innerText =
        `Coins: ${Math.floor(coin)} (+${klik_kracht} per klik)`;
    let costIds = ["upgrade10", "upgrade50", "upgrade100", "upgrade1000", "upgrade2000", "upgrade10000", "upgrade50000", "upgrade100000"];
    for (let i = 0; i < costIds.length; i++) {
        document.getElementById(costIds[i]).disabled = coin < COSTS[i];
    }
}

function flashButton(id) {
    let btn = document.getElementById(id);
    btn.classList.add('upgrade-flash', 'upgrade-press');
    setTimeout(() => btn.classList.remove('upgrade-flash', 'upgrade-press'), 200);
}

function playPlop() {
    let audio = new Audio("plop.mp3");
    audio.volume = 0.3;
    audio.play();
}

function playKaching() {
    let audio = new Audio("kaching.mp3");
    audio.volume = 0.3;
    audio.play();
}

function recalcFromCounts() {
    klik_kracht = 1 + CLICK_INC.reduce((sum, inc, i) => sum + inc * (upgradeCounts[i] || 0), 0);
    autoCoinIncrements = AUTO_INC.map((inc, i) => inc * (upgradeCounts[i] || 0));
}

function saveGame() {
    try {
        let payload = {
            coins: coin,
            counts: upgradeCounts
        };
        localStorage.setItem(SAVE_KEY_GAME, JSON.stringify(payload));
    } catch (e) {
        console.warn("Kon game niet opslaan:", e);
    }
}

function loadGame() {
    try {
        let raw = localStorage.getItem(SAVE_KEY_GAME);
        if (!raw) {
            recalcFromCounts();
            return;
        }
        let data = JSON.parse(raw);
        coin = Number(data.coins || 0);
        let savedCounts = Array.isArray(data.counts) ? data.counts : [];
        for (let i = 0; i < upgradeCounts.length; i++) {
            upgradeCounts[i] = Number(savedCounts[i] || 0);
            let span = document.getElementById(`count${i}`);
            if (span) span.textContent = upgradeCounts[i];
        }
        recalcFromCounts();
    } catch (e) {
        console.warn("Kon game niet laden:", e);
        recalcFromCounts();
    }
}

function hardReset() {
    coin = 0;
    upgradeCounts = Array(8).fill(0);
    recalcFromCounts();
    saveGame();
    let allowed = new Set(["default"]);
    let order = ["default"];
    saveUnlocked(allowed, order);
    setCurrentWorldKey("default");
    for (let i = 0; i < 8; i++) {
        let span = document.getElementById(`count${i}`);
        if (span) span.textContent = "0";
    }
    let extra = document.getElementById("extra_upgrades");
    if (extra) extra.innerHTML = "";
    applyWorldByKey("default", false);
    renderUnlocked();
    highlightCurrentWorld();
    ui_update();
    let popup = document.getElementById("achievementPopup");
    popup.innerText = "ðŸ”„ Progress gereset!";
    popup.style.display = "block";
    popup.style.animation = "popupFade 2s forwards";
    setTimeout(() => (popup.style.display = "none"), 2000);
}
class MiniGame {
    constructor() {
        this.score = 0;
        this.highscore = Number(localStorage.getItem('minigame_highscore') || 0);
        this.timeLeft = 60;
        this.timerInterval = null;
        this.overlay = document.getElementById('minigame-overlay');
        this.coin = document.getElementById('minigame-coin');
        this.timerEl = document.getElementById('minigame-timer');
        this.scoreEl = document.getElementById('minigame-score');
        this.result = document.getElementById('minigame-result');
        this.finalScore = document.getElementById('minigame-final-score');
        this.highscoreEl = document.getElementById('minigame-highscore');
        this.btnReturn = document.getElementById('btn-return');
        this.coin.addEventListener('click', () => this.clickCoin());
        this.btnReturn.addEventListener('click', () => this.close());
        document.getElementById('btn-minigame').addEventListener('click', () => this.start());
    }
    start() {
        this.score = 0;
        this.timeLeft = 60;
        this.overlay.style.display = 'flex';
        this.result.style.display = 'none';
        this.updateUI();
        this.timerInterval = setInterval(() => {
            this.timeLeft--;
            this.timerEl.textContent = this.timeLeft;
            if (this.timeLeft <= 0) this.end();
        }, 1000);
    }
    clickCoin() {
        this.score++;
        this.scoreEl.textContent = `Score: ${this.score}`;
        this.coin.classList.add('clicked');
        setTimeout(() => this.coin.classList.remove('clicked'), 100);
    }
    end() {
        clearInterval(this.timerInterval);
        this.result.style.display = 'block';
        this.finalScore.textContent = `Jouw score: ${this.score}`;
        if (this.score > this.highscore) {
            this.highscore = this.score;
            localStorage.setItem('minigame_highscore', this.highscore);
        }
        this.highscoreEl.textContent = `Highscore: ${this.highscore}`;
    }
    close() {
        this.overlay.style.display = 'none';
    }
    updateUI() {
        this.timerEl.textContent = this.timeLeft;
        this.scoreEl.textContent = `Score: ${this.score}`;
    }
}

function attachEventListeners() {
    let coinImg = document.querySelector(".coin-icon");
    coinImg.addEventListener("click", click_actie);
    let btnIds = [
    ["upgrade10", 0],
    ["upgrade50", 1],
    ["upgrade100", 2],
    ["upgrade1000", 3],
    ["upgrade2000", 4],
    ["upgrade10000", 5],
    ["upgrade50000", 6],
    ["upgrade100000", 7],
  ];
    btnIds.forEach(([id, idx]) => {
        let el = document.getElementById(id);
        if (el) el.addEventListener("click", () => Upgrade(idx));
    });
}
(function init() {
    loadGame();
    reconcileUnlocksWithProgress();
    ensureUnlockedPanel();
    renderUnlocked();
    let savedWorld = getCurrentWorldKey();
    let unlockedNow = getUnlockedSet();
    if (!savedWorld || !unlockedNow.has(savedWorld)) {
        savedWorld = "default";
        setCurrentWorldKey(savedWorld);
    }
    applyWorldByKey(savedWorld, false);
    setInterval(() => {
        coin += autoCoinIncrements.reduce((a, b) => a + b, 0);
        ui_update();
    }, 1000);
    setInterval(saveGame, 5000);
    window.addEventListener('beforeunload', saveGame);
    ui_update();
    attachEventListeners();
    let minigame = new MiniGame();
})();
